<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Elite Cup Standings</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
body { margin: 0; background: transparent; overflow: hidden; }

/* Top Left Hitbox: EWC (Top 8) */
#ewcBtn {
  position: absolute;
  top: 0;
  left: 0;
  width: 50vw;
  height: 50vh;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 10001;
  outline: none;
}

/* Bottom Left Hitbox: ENC (Top 16 Nations) */
#encBtn {
  position: absolute;
  top: 50vh;
  left: 0;
  width: 50vw;
  height: 50vh;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 10001;
  outline: none;
}

/* Right Half Hitbox: Page Toggle (or Return to All) */
#pageToggleBtn {
  position: absolute;
  top: 0;
  right: 0;
  width: 50vw;
  height: 100vh;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 10000;
  outline: none;
}

/* Header Section */
#header-container {
  position: absolute;
  left: 134px;
  top: 239px;
  width: 1654px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

#header-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 64px;
  font-weight: 600;
  color: white;
  text-transform: uppercase;
  margin-bottom: 30px;
  line-height: 1;
}

#header-line {
  width: 100%;
  height: 2px;
  background: white;
  margin-bottom: 30px;
}

/* Master Grid: Fixed Total Size 1654x518 */
.standings {
  position: absolute;
  left: 134px;
  top: 365px;
  width: 1654px;
  height: 518px;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(8, 56px);
  grid-auto-flow: column;
  row-gap: 10px;
  column-gap: 10px;
}

.standing-item {
  display: flex;
  align-items: center;
  height: 56px;
  width: 100%;
  font-family: 'Montserrat', sans-serif;
  color: white;
  animation: fadeIn 0.4s ease-out;
}

.rank-number {
  width: 56px;
  height: 56px;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: #262626;
  font-size: 28px;
  font-weight: 600;
}

.player-data-box {
  flex-grow: 1;
  height: 56px;
  background: rgba(0, 0, 0, 0.65);
  border: 1px solid white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 15px;
  box-sizing: border-box;
}

.name-meta-wrapper {
  display: flex;
  align-items: center;
}

.flag-icon {
  width: 32px;
  height: auto;
  margin-right: 15px;
  flex-shrink: 0;
}

.name-meta-text-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  line-height: 1.1;
}

.player-name {
  font-size: 22px;
  font-weight: 600;
}

.team-full-name {
  font-size: 12px;
  color: #adadad;
  font-weight: 400;
  text-transform: uppercase;
}

.points-val {
  font-size: 24px;
  font-weight: 600;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<button id="ewcBtn" onclick="setMode('EWC')"></button>
<button id="encBtn" onclick="setMode('ENC')"></button>
<button id="pageToggleBtn" onclick="togglePage()"></button>

<div id="header-container">
  <div id="header-title">ELITE CUP STANDINGS</div>
  <div id="header-line"></div>
</div>

<div class="standings" id="standings"></div>

<script src="config.js"></script>
<script>
/* ===============================
   STATE & CONSTANTS
================================ */
let championship = {};
let allFinalData = []; 
let currentPage = 1;
let viewMode = 'ALL'; 

const TM_TO_ISO = {
  "eng": "gb", "sct": "gb", "wal": "gb", "en": "gb", "gbr": "gb",
  "swe": "se", "nor": "no", "den": "dk", "fin": "fi", "ned": "nl",
  "bel": "be", "lux": "lu", "irl": "ie", "ger": "de", "sui": "ch",
  "aut": "at", "pol": "pl", "cze": "cz", "svk": "sk", "slo": "si",
  "cro": "hr", "hun": "hu", "rom": "ro", "bul": "bg", "gre": "gr",
  "tur": "tr", "fra": "fr", "esp": "es", "ita": "it", "por": "pt",
  "usa": "us", "can": "ca", "bra": "br", "aus": "au", "nzl": "nz", "rsa": "za"
};

/* ===============================
   LOGIC
================================ */
function getPoints(position) {
  if (position === 1) return 1000;
  if (position === 2) return 700;
  if (position === 3) return 600;
  if (position === 4) return 500;
  if (position === 5) return 400;
  if (position === 6) return 300;
  if (position === 7) return 200;
  if (position === 8) return 100;
  if (position >= 9 && position <= 16) return 96 - ((position - 9) * 4);
  if (position >= 17 && position <= 32) return 64 - (Math.floor((position - 17) / 2) * 4);
  if (position >= 33 && position <= 64) return 32 - (Math.floor((position - 33) / 2) * 2);
  return 0;
}

function findCountryCode(playerObj) {
  let current = playerObj.zone;
  while (current) {
    if (current.flag && current.flag.length === 3) {
      const code = current.flag.toLowerCase();
      return TM_TO_ISO[code] || code.substring(0, 2);
    }
    current = current.parent;
  }
  return "un";
}

function getTeamData(playerName) {
  const nameUpper = playerName.toUpperCase();
  return CONFIG.STANDINGS.TEAMS.find(team => 
    team.keywords.some(key => nameUpper.includes(key.toUpperCase()))
  ) || null;
}

function updateHeaderAndGrid() {
  const title = document.getElementById("header-title");
  const container = document.getElementById("standings");

  if (viewMode === 'ENC') {
    title.textContent = "ENC STANDINGS";
    container.style.gridTemplateColumns = "repeat(2, 1fr)";
  } else if (viewMode === 'EWC') {
    title.textContent = "EWC STANDINGS";
    container.style.gridTemplateColumns = "repeat(1, 1fr)";
  } else {
    title.textContent = currentPage === 1 ? "ELITE CUP STANDINGS 1-32" : "ELITE CUP STANDINGS 33-64";
    container.style.gridTemplateColumns = "repeat(4, 1fr)";
  }
}

function setMode(mode) {
  viewMode = (viewMode === mode) ? 'ALL' : mode;
  updateHeaderAndGrid();
  renderStandings(allFinalData);
}

function togglePage() {
  if (viewMode === 'ALL') {
    currentPage = (currentPage === 1) ? 2 : 1;
  } else {
    viewMode = 'ALL';
  }
  updateHeaderAndGrid();
  renderStandings(allFinalData);
}

/* ===============================
   RENDER ENGINE
================================ */
async function loadAll() {
  for (const match of CONFIG.STANDINGS.MATCHES) {
    const res = await fetch(CONFIG.PROXY_BASE + match);
    const data = await res.json();
    (data?.results || []).forEach((entry, index) => {
      const name = entry.player?.name || "Unknown";
      if (!championship[name]) {
        championship[name] = { points: 0, country: findCountryCode(entry.player) };
      }
      championship[name].points += getPoints(index + 1);
    });
  }
  allFinalData = Object.entries(championship)
    .map(([name, info]) => ({ name, points: info.points, country: info.country }))
    .sort((a, b) => b.points - a.points);
  updateHeaderAndGrid();
  renderStandings(allFinalData);
}

function renderStandings(data) {
  const container = document.getElementById("standings");
  container.innerHTML = "";
  let displayData = [];
  const start = (currentPage - 1) * 32;

  if (viewMode === 'ENC') {
    const seen = new Set();
    displayData = data.filter(p => {
      if (seen.has(p.country) || p.country === 'un') return false;
      seen.add(p.country);
      return true;
    }).slice(0, 16);
  } else if (viewMode === 'EWC') {
    displayData = data.slice(0, 8);
  } else {
    displayData = data.slice(start, start + 32);
  }

  displayData.forEach((player, index) => {
    const team = getTeamData(player.name);
    const row = document.createElement("div");
    row.className = "standing-item";

    const rank = document.createElement("div");
    rank.className = "rank-number";
    rank.textContent = (viewMode === 'ALL') ? (start + index + 1) : (index + 1);
    row.appendChild(rank);

    const dataBox = document.createElement("div");
    dataBox.className = "player-data-box";

    const nameGroup = document.createElement("div");
    nameGroup.className = "name-meta-wrapper";

    const flag = document.createElement("img");
    flag.className = "flag-icon";
    flag.src = `https://flagcdn.com/w40/${player.country}.png`;
    flag.onerror = function() { this.src='https://flagcdn.com/w40/un.png'; };

    const textStack = document.createElement("div");
    textStack.className = "name-meta-text-wrapper";
    
    const pName = document.createElement("span");
    pName.className = "player-name";
    pName.textContent = player.name;
    textStack.appendChild(pName);

    if (team) {
      const tName = document.createElement("span");
      tName.className = "team-full-name";
      tName.textContent = team.fullName;
      textStack.appendChild(tName);
    }

    nameGroup.appendChild(flag);
    nameGroup.appendChild(textStack);

    const pts = document.createElement("span");
    pts.className = "points-val";
    pts.textContent = player.points;

    dataBox.appendChild(nameGroup);
    dataBox.appendChild(pts);
    row.appendChild(dataBox);
    container.appendChild(row);
  });
}

loadAll();
</script>
</body>
</html>
